<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>دوز - AI با یادگیری از بردهای کاربر</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Segoe UI',Tahoma;
            background:linear-gradient(135deg,#667eea,#764ba2);
            min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px
        }
        .container{
            background:#fff;border-radius:20px;max-width:480px;width:100%;
            padding:24px;box-shadow:0 18px 40px rgba(0,0,0,.25)
        }
        h1{text-align:center;color:#667eea;margin-bottom:8px}
        .subtitle{text-align:center;color:#666;margin-bottom:20px;font-size:.9em}
        .board{
            display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px
        }
        .cell{
            background:#f0f0f0;border:none;border-radius:12px;
            font-size:2.5em;font-weight:bold;color:#333;
            cursor:pointer;display:flex;align-items:center;justify-content:center;
            aspect-ratio:1;transition:.2s
        }
        .cell:hover:not(.occupied){background:#e0e0e0;transform:scale(.96)}
        .cell.x{color:#667eea}
        .cell.o{color:#764ba2}
        .cell.winner{background:#4caf50;color:#fff}
        .stats{background:#f9f9f9;border-radius:10px;padding:10px 12px;margin-bottom:16px;font-size:.9em}
        .stat-item{display:flex;justify-content:space-between;margin-bottom:4px;color:#555}
        .stat-item:last-child{margin-bottom:0;font-weight:bold;color:#667eea;padding-top:4px;border-top:1px solid #e0e0e0}
        .message{text-align:center;margin-bottom:10px;font-weight:600}
        .controls{display:flex;gap:8px;flex-wrap:wrap}
        button.ctrl{
            flex:1;min-width:120px;border:none;border-radius:10px;padding:10px;
            font-weight:600;cursor:pointer;transition:.2s
        }
        .primary{background:#667eea;color:#fff}
        .primary:hover{background:#5568d3}
        .secondary{background:#f0f0f0}
        .secondary:hover{background:#e0e0e0}
        .danger{background:#f44336;color:#fff}
        .danger:hover{background:#d32f2f}
        .small{font-size:.8em;margin-top:6px;color:#777;text-align:center}
        .patterns-count{font-size:.85em;color:#444;text-align:center;margin-bottom:8px}
    </style>
</head>
<body>
<div class="container">
    <h1>بازی دوز</h1>
    <p class="subtitle">AI از الگوهای برد شما یاد می‌گیرد و سعی می‌کند جلوی آن‌ها را بگیرد</p>

    <div class="stats">
        <div class="stat-item">
            <span>بازی‌های انجام‌شده:</span><span id="totalGames">0</span>
        </div>
        <div class="stat-item">
            <span>بردهای AI (X):</span><span id="aiWins">0</span>
        </div>
        <div class="stat-item">
            <span>بردهای شما (O):</span><span id="userWins">0</span>
        </div>
        <div class="stat-item">
            <span>مساوی‌ها:</span><span id="draws">0</span>
        </div>
    </div>

    <div class="patterns-count">
        الگوهای برد ذخیره‌شده کاربر: <span id="patternCount">0</span>
    </div>

    <div class="board" id="board">
        <button class="cell" data-index="0"></button>
        <button class="cell" data-index="1"></button>
        <button class="cell" data-index="2"></button>
        <button class="cell" data-index="3"></button>
        <button class="cell" data-index="4"></button>
        <button class="cell" data-index="5"></button>
        <button class="cell" data-index="6"></button>
        <button class="cell" data-index="7"></button>
        <button class="cell" data-index="8"></button>
    </div>

    <div class="message" id="message">نوبت شماست! روی یک خانه کلیک کنید.</div>
    <div class="small">X = AI ، O = شما. هر بار که شما برنده شوید، الگوی بردتان ذخیره می‌شود.</div>

    <div class="controls">
        <button class="ctrl primary" onclick="startNewGame()">بازی جدید</button>
        <button class="ctrl secondary" onclick="resetMemory()">پاک‌کردن حافظه AI</button>
        <button class="ctrl danger" onclick="resetAll()">ریست کامل (بازی + حافظه)</button>
    </div>
</div>

<script>
    // ===== داده‌ها و وضعیت کلی =====
    let board = Array(9).fill(null); // null, 'X', 'O'
    let currentPlayer = 'user';      // 'user' یا 'ai'
    let gameActive = true;

    // آمار ساده
    const stats = { total: 0, aiWins: 0, userWins: 0, draws: 0 };

    // الگوهای برد کاربر:
    // هر آیتم: { state: "XO O  X  ", action: 5 }
    // state: رشته ۹ کاراکتری شامل 'X' یا 'O' یا ' '
    // action: ایندکسی که کاربر در آن حرکت کرده و نهایتاً این بازی را برده
    let userWinningPatterns = [];

    // ===== کمک‌ها =====
    function stateToString(arr){
        return arr.map(c => c ? c : ' ').join('');
    }

    function getAvailableActions(arr){
        const res = [];
        arr.forEach((c,i)=>{ if(!c) res.push(i); });
        return res;
    }

    function checkWinner(arr){
        const lines = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for(const [a,b,c] of lines){
            if(arr[a] && arr[a]===arr[b] && arr[b]===arr[c]) return arr[a];
        }
        return arr.includes(null) ? null : 'draw';
    }

    function highlightWin(arr){
        const lines = [
            [0,1,2],[3,4,5],[6,7,8],
            [0,3,6],[1,4,7],[2,5,8],
            [0,4,8],[2,4,6]
        ];
        for(const [a,b,c] of lines){
            if(arr[a] && arr[a]===arr[b] && arr[b]===arr[c]){
                document.querySelector(`[data-index="${a}"]`).classList.add('winner');
                document.querySelector(`[data-index="${b}"]`).classList.add('winner');
                document.querySelector(`[data-index="${c}"]`).classList.add('winner');
                break;
            }
        }
    }

    // ===== حافظه در localStorage =====
    const STORAGE_KEY = 'ttt-ai-user-winning-patterns-v1';
    const STATS_KEY   = 'ttt-ai-stats-v1';

    function saveMemory(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userWinningPatterns));
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }

    function loadMemory(){
        const m = localStorage.getItem(STORAGE_KEY);
        if(m){
            try{ userWinningPatterns = JSON.parse(m) || []; }catch(e){}
        }
        const s = localStorage.getItem(STATS_KEY);
        if(s){
            try{
                const obj = JSON.parse(s);
                stats.total   = obj.total   || 0;
                stats.aiWins  = obj.aiWins  || 0;
                stats.userWins= obj.userWins|| 0;
                stats.draws   = obj.draws   || 0;
            }catch(e){}
        }
        updateStatsUI();
        updatePatternCountUI();
    }

    function resetMemory(){
        if(!confirm('حافظه الگوهای برد کاربر پاک شود؟')) return;
        userWinningPatterns = [];
        localStorage.removeItem(STORAGE_KEY);
        updatePatternCountUI();
        setMessage('حافظه بردهای شما از AI پاک شد.');
    }

    function resetAll(){
        if(!confirm('هم حافظه AI و هم آمار بازی‌ها پاک شود؟')) return;
        userWinningPatterns = [];
        stats.total = stats.aiWins = stats.userWins = stats.draws = 0;
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STATS_KEY);
        updateStatsUI();
        updatePatternCountUI();
        startNewGame();
        setMessage('همه‌چیز ریست شد. از نو شروع کنید.');
    }

    // ===== UI =====
    function renderBoard(){
        document.querySelectorAll('.cell').forEach((cell,i)=>{
            const v = board[i];
            cell.textContent = v ? v : '';
            cell.className = 'cell';
            if(v){
                cell.classList.add('occupied');
                cell.classList.add(v==='X' ? 'x':'o');
            }
        });
    }

    function setMessage(msg){
        document.getElementById('message').textContent = msg;
    }

    function updateStatsUI(){
        document.getElementById('totalGames').textContent = stats.total;
        document.getElementById('aiWins').textContent    = stats.aiWins;
        document.getElementById('userWins').textContent  = stats.userWins;
        document.getElementById('draws').textContent     = stats.draws;
    }

    function updatePatternCountUI(){
        document.getElementById('patternCount').textContent = userWinningPatterns.length;
    }

    // ===== منطق یادگیری از بردهای کاربر =====
    // در هر حرکت ذخیره می‌کنیم: حالت قبل از حرکت + خانه‌ای که کاربر یا AI زد
    let gameMoveHistory = []; // آرایه‌ای از { player, stateBefore, action }

    function recordMove(player, stateBefore, action){
        gameMoveHistory.push({ player, stateBefore, action });
    }

    // وقتی کاربر (O) برنده شد:
    // همهٔ recordهایی که player === 'O' هستند را به userWinningPatterns اضافه می‌کنیم
    function learnFromUserWin(){
        for(const m of gameMoveHistory){
            if(m.player === 'O'){
                // اگر از قبل این الگو را نداریم، اضافه‌اش می‌کنیم
                const exists = userWinningPatterns.some(p => p.state === m.stateBefore && p.action === m.action);
                if(!exists){
                    userWinningPatterns.push({ state: m.stateBefore, action: m.action });
                }
            }
        }
        saveMemory();
        updatePatternCountUI();
    }

    // ===== AI: استفاده از الگوهای برد کاربر =====
    function aiChooseAction(){
        const currentState = stateToString(board);
        const available = getAvailableActions(board);
        if(available.length === 0) return null;

        // 1) ابتدا چک می‌کنیم آیا الگوی بردی از کاربر برای این state داریم یا نه
        const matchingPatterns = userWinningPatterns.filter(p => p.state === currentState);

        // اگر الگوی دقیقاً همین state وجود داشته باشد، AI همان خانه را خودش می‌گیرد
        for(const p of matchingPatterns){
            if(available.includes(p.action)){
                return p.action;
            }
        }

        // 2) اگر الگوی دقیقی نبود: حرکت تصادفی
        const r = Math.floor(Math.random() * available.length);
        return available[r];
    }

    // ===== پایان بازی =====
    function checkGameEndAndHandle(){
        const res = checkWinner(board);
        if(res === null) return false;

        gameActive = false;
        stats.total++;

        if(res === 'X'){
            stats.aiWins++;
            setMessage('AI (X) برنده شد.');
            highlightWin(board);
        }else if(res === 'O'){
            stats.userWins++;
            setMessage('شما (O) برنده شدید! الگوهای برد شما به حافظه AI اضافه شد.');
            highlightWin(board);
            learnFromUserWin(); // اینجا یادگیری از برد کاربر انجام می‌شود
        }else{
            stats.draws++;
            setMessage('بازی مساوی شد.');
        }

        saveMemory();
        updateStatsUI();
        return true;
    }

    // ===== حرکت‌ها =====
    function onUserClickCell(i){
        if(!gameActive || currentPlayer!=='user' || board[i]) return;

        const stateBefore = stateToString(board);
        board[i] = 'O';
        recordMove('O', stateBefore, i);
        renderBoard();

        if(checkGameEndAndHandle()) return;

        currentPlayer = 'ai';
        setTimeout(aiMove, 300);
    }

    function aiMove(){
        if(!gameActive) return;

        const stateBefore = stateToString(board);
        const action = aiChooseAction();
        if(action === null) return;

        board[action] = 'X';
        recordMove('X', stateBefore, action);
        renderBoard();

        if(checkGameEndAndHandle()) return;

        currentPlayer = 'user';
        setMessage('نوبت شماست!');
    }

    function startNewGame(){
        board = Array(9).fill(null);
        gameMoveHistory = [];
        currentPlayer = 'user';
        gameActive = true;
        renderBoard();
        setMessage('نوبت شماست! روی یک خانه کلیک کنید.');
    }

    // ===== رویدادها =====
    document.querySelectorAll('.cell').forEach(cell=>{
        cell.addEventListener('click', e=>{
            const i = parseInt(e.target.dataset.index,10);
            onUserClickCell(i);
        });
    });

    window.addEventListener('load', ()=>{
        loadMemory();
        startNewGame();
    });
</script>
</body>
</html>
