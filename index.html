<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯ÙˆØ² â€“ AI ÙˆØ§Ù‚Ø¹ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±Ù†Ø¯Ù‡</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
    font-family:Segoe UI,Tahoma;
    background:linear-gradient(135deg,#667eea,#764ba2);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:20px
}
.container{
    background:#fff;
    border-radius:20px;
    padding:30px;
    max-width:480px;
    width:100%;
    box-shadow:0 20px 50px rgba(0,0,0,.3)
}
h1{text-align:center;color:#667eea;margin-bottom:10px}
.subtitle{text-align:center;color:#666;margin-bottom:20px;font-size:.9em}
.board{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin:20px 0
}
.cell{
    aspect-ratio:1;
    font-size:3em;
    border:none;
    border-radius:14px;
    background:#f2f2f2;
    cursor:pointer;
    transition:.2s;
}
.cell:hover:not(.filled){background:#e0e0e0}
.cell.X{color:#667eea}
.cell.O{color:#764ba2}
.cell.win{background:#4caf50;color:#fff}
.controls{display:flex;gap:10px;margin-top:15px}
button{
    flex:1;
    padding:10px;
    border:none;
    border-radius:10px;
    font-weight:600;
    cursor:pointer
}
.primary{background:#667eea;color:#fff}
.secondary{background:#eee}
.danger{background:#f44336;color:#fff}
.message{text-align:center;font-weight:600;min-height:28px}
.stats{
    background:#f7f7f7;
    border-radius:10px;
    padding:12px;
    font-size:.85em
}
.stats div{display:flex;justify-content:space-between;margin:4px 0}
</style>
</head>

<body>
<div class="container">
<h1>Ø¯ÙˆØ²</h1>
<p class="subtitle">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ú©Ù‡ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø§Ø² Ø¨Ø§Ø®Øª ÛŒØ§Ø¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡</p>

<div class="stats">
<div><span>Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§</span><span id="g">0</span></div>
<div><span>Ø¨Ø±Ø¯ AI</span><span id="aw">0</span></div>
<div><span>Ø¨Ø±Ø¯ Ø´Ù…Ø§</span><span id="uw">0</span></div>
<div><span>Ù…Ø³Ø§ÙˆÛŒ</span><span id="d">0</span></div>
<div><span>Îµ</span><span id="e">1.00</span></div>
</div>

<div class="board" id="board"></div>
<div class="message" id="msg"></div>

<div class="controls">
<button class="primary" onclick="newGame()">Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
<button class="secondary" onclick="train(2000)">Ø¢Ù…ÙˆØ²Ø´ Ã—2000</button>
<button class="danger" onclick="resetAI()">Ø±ÛŒØ³Øª AI</button>
</div>
</div>

<script>
/* ================= Q-Learning AI ================= */

class QLearningAI {
    constructor(){
        this.q = {};
        this.epsilon = 1.0;
        this.epsilonMin = 0.05;
        this.epsilonDecay = 0.995;
        this.alpha = 0.4;
        this.history = [];
    }

    key(state,action){ return state + "|" + action }

    getQ(state,action){
        const k = this.key(state,action);
        if(this.q[k] === undefined) this.q[k] = 0;
        return this.q[k];
    }

    choose(board,train=true){
        const state = board.join('');
        const moves = board.map((c,i)=>c===''?i:null).filter(i=>i!==null);
        if(train && Math.random()<this.epsilon){
            return moves[Math.floor(Math.random()*moves.length)];
        }
        let best = moves[0], bestVal = -Infinity;
        for(const m of moves){
            const v = this.getQ(state,m);
            if(v>bestVal){bestVal=v;best=m}
        }
        return best;
    }

    record(board,action){
        this.history.push({state:board.join(''),action});
    }

    learn(result){
        const reward = result==='X'?1:result==='O'?-1:0.3;
        for(const step of this.history){
            const k = this.key(step.state,step.action);
            this.q[k] += this.alpha * (reward - this.q[k]);
        }
        this.history=[];
        this.epsilon = Math.max(this.epsilonMin,this.epsilon*this.epsilonDecay);
        this.save();
    }

    save(){
        localStorage.setItem("ttt-ai",JSON.stringify({
            q:this.q,epsilon:this.epsilon,stats
        }));
    }

    load(){
        const d = localStorage.getItem("ttt-ai");
        if(!d) return;
        const s = JSON.parse(d);
        this.q = s.q || {};
        this.epsilon = s.epsilon || 1;
        Object.assign(stats,s.stats||{});
    }

    reset(){
        this.q={}; this.epsilon=1; this.history=[];
        localStorage.removeItem("ttt-ai");
    }
}

/* ================= Game Logic ================= */

const ai = new QLearningAI();
const boardEl = document.getElementById("board");
const msg = document.getElementById("msg");

let board, turn, active;

const stats = {g:0,aw:0,uw:0,d:0};

function drawBoard(){
    boardEl.innerHTML='';
    board.forEach((c,i)=>{
        const b=document.createElement("button");
        b.className="cell"+(c?' filled '+c:'');
        b.textContent=c;
        b.onclick=()=>playerMove(i);
        boardEl.appendChild(b);
    });
}

function check(){
    const w=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for(const [a,b,c] of w){
        if(board[a]&&board[a]===board[b]&&board[a]===board[c]) return board[a];
    }
    return board.includes('')?null:'draw';
}

function playerMove(i){
    if(!active||turn!=='O'||board[i])return;
    board[i]='O'; turn='X'; drawBoard();
    endOrAI();
}

function aiMove(){
    const before=[...board];
    const a=ai.choose(board,true);
    board[a]='X';
    ai.record(before,a);
    turn='O';
    drawBoard();
    endOrAI();
}

function endOrAI(){
    const r=check();
    if(r){
        active=false;
        stats.g++;
        if(r==='X'){stats.aw++;msg.textContent="AI Ø¨Ø±Ø¯ ğŸ˜ˆ"}
        else if(r==='O'){stats.uw++;msg.textContent="Ø¨Ø±Ø¯ÛŒ! ğŸ”¥"}
        else{stats.d++;msg.textContent="Ù…Ø³Ø§ÙˆÛŒ ğŸ¤"}
        ai.learn(r);
        updateStats();
    } else if(turn==='X'){
        setTimeout(aiMove,300);
    }
}

function newGame(){
    board=Array(9).fill('');
    turn=Math.random()<0.5?'X':'O';
    active=true;
    ai.history=[];
    drawBoard();
    msg.textContent=turn==='O'?"Ù†ÙˆØ¨Øª ØªÙˆØ¦Ù‡":"AI Ø´Ø±ÙˆØ¹ Ú©Ø±Ø¯";
    if(turn==='X') setTimeout(aiMove,300);
}

function updateStats(){
    g.textContent=stats.g;
    aw.textContent=stats.aw;
    uw.textContent=stats.uw;
    d.textContent=stats.d;
    e.textContent=ai.epsilon.toFixed(3);
}

function train(n){
    for(let i=0;i<n;i++){
        let b=Array(9).fill('');
        ai.history=[];
        let t='X';
        while(true){
            const r=check.call({board:b});
            if(r){ai.learn(r);break;}
            const before=[...b];
            const a=ai.choose(b,true);
            b[a]=t;
            if(t==='X') ai.record(before,a);
            t=t==='X'?'O':'X';
        }
    }
    updateStats();
    msg.textContent="Ø¢Ù…ÙˆØ²Ø´ ØªÙ…ÙˆÙ… Ø´Ø¯ ğŸ§ ";
}

function resetAI(){
    if(confirm("Ù‡Ù…Ù‡â€ŒÚ†ÛŒ Ù¾Ø§Ú© Ø¨Ø´Ù‡ØŸ")){
        ai.reset();
        stats.g=stats.aw=stats.uw=stats.d=0;
        updateStats();
        newGame();
    }
}

ai.load();
updateStats();
newGame();
</script>
</body>
</html>
